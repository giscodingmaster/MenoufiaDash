<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ูุชุงุจุนุฉ ุงูุนูููุงุช - Dashboard</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2936/2936719.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; font-size: 0.9rem; }
        .card { border: none; shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .stat-card { border-right: 5px solid #0d6efd; background: white; padding: 15px; border-radius: 8px; }
        .stat-number { font-size: 1.8rem; font-weight: bold; color: #333; }
        .stat-label { color: #666; font-size: 0.85rem; }
        #loading { text-align: center; margin-top: 50px; }
        .filter-section { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .table-responsive { max-height: 650px; overflow-y: auto; }
        thead th { position: sticky; top: 0; z-index: 1020; background-color: #212529; color: white; }
        .badge { font-size: 0.8rem; padding: 0.5em 0.7em; }
        
        /* Install Button Style */
        #installBtn { display: none; position: fixed; bottom: 20px; left: 20px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<!-- Install Button -->
<button id="installBtn" class="btn btn-dark btn-lg">๐ฒ ุชุซุจูุช ุงูุชุทุจูู</button>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 px-3">
        <h3 class="fw-bold text-primary">ููุญุฉ ูุชุงุจุนุฉ ุณูุฑ ุงูุนูู ุงููููู</h3>
        <span class="badge bg-secondary" id="last-update">ุฌุงุฑู ุงูุชุญููู...</span>
    </div>

    <!-- ูุณู ุงูููุชุฑุฉ -->
    <div class="container px-3">
        <div class="filter-section">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label for="dateFilter" class="form-label fw-bold">ุชุญุฏูุฏ ููู ููุนุฑุถ:</label>
                    <input type="date" id="dateFilter" class="form-control">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100 mb-2 mb-md-0" onclick="applyDateFilter()">ุนุฑุถ ุชูุงุตูู ูุฐุง ุงูููู</button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="resetFilter()">ุนุฑุถ ุงููู</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช... ูุฑุฌู ุงูุงูุชุธุงุฑ</p>
    </div>

    <div id="dashboard" style="display:none;" class="px-3">
        
        <!-- ุงูุฅุญุตุงุฆูุงุช -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card" style="border-color: #0d6efd;">
                    <div class="stat-number" id="total-rows">0</div>
                    <div class="stat-label">ุฅุฌูุงูู ุงูุนูููุงุช</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-color: #198754;">
                    <div class="stat-number" id="site-work">0</div>
                    <div class="stat-label">ุฒูุงุฑุงุช ููุฏุงููุฉ</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-color: #ffc107;">
                    <div class="stat-number" id="office-work">0</div>
                    <div class="stat-label">ุนูู ููุชุจู</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card" style="border-color: #dc3545;">
                    <div class="stat-number" id="unique-names">0</div>
                    <div class="stat-label">ุงูููุธููู</div>
                </div>
            </div>
        </div>

        <!-- ุงูุฌุฏูู ุงูุชูุตููู -->
        <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title fw-bold text-dark" id="tableTitle">ุณุฌู ุงูุชูุงุตูู ุงูููููุฉ</h5>
                <button class="btn btn-sm btn-outline-info" onclick="debugColumns()">ูุญุต ุฃุณูุงุก ุงูุฃุนูุฏุฉ</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-bordered table-striped align-middle" id="dataTable">
                    <thead class="table-dark">
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูุดุฑูุฉ</th>
                            <th>ุงูุงุณู</th>
                            <th>ููุน ุงูุนูู</th>
                            <th>ุญุงูุฉ ุงูููู</th>
                            <th style="min-width: 250px;">ุชูุงุตูู ุงููุดุงุท</th>
                            <th>ููุน ุงูุฌูุงุฒ</th>
                            <th>ูุณููุฉ ุงูููุงุตูุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ุงููุฎุทุทุงุช ุงูุจูุงููุฉ -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card p-3">
                    <h6 class="card-title">ุชูุฒูุน ููุน ุงูุนูู</h6>
                    <div style="height: 250px; display: flex; justify-content: center;">
                        <canvas id="workTypeChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3">
                    <h6 class="card-title">ุงูุนูููุงุช ุญุณุจ ุงูุดุฑูุฉ</h6>
                    <div style="height: 250px;">
                        <canvas id="regionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // 1. Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker Registered'))
                .catch(err => console.log('Service Worker Failed', err));
        });
    }

    // 2. Install Button Logic
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', (e) => {
        installBtn.style.display = 'none';
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the A2HS prompt');
            }
            deferredPrompt = null;
        });
    });

    // ------------------------------------------
    // Existing Dashboard Logic
    // ------------------------------------------

    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXksG_WORJ0cqddSJ9Kr-UyYWECAlOhWFif6zc8alnd6knMpZwmK6zznZRu-vrvPFfWN4pg_cbIfla/pub?output=csv";
    
    let allData = []; 
    let chart1Instance = null;
    let chart2Instance = null;
    let foundHeaders = []; 

    function init() {
        Papa.parse(sheetURL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            transformHeader: function(h) {
                return h.trim();
            },
            complete: function(results) {
                if (results.data && results.data.length > 0) {
                    allData = results.data;
                    foundHeaders = results.meta.fields; 
                    
                    document.getElementById('last-update').innerText = "ุชุญุฏูุซ: " + new Date().toLocaleTimeString('ar-EG');
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';

                    updateDashboard(allData, "ุนุฑุถ ุฌููุน ุงูุณุฌูุงุช");
                } else {
                    alert("ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ูู ุงูููู.");
                }
            },
            error: function(err) {
                console.error(err);
                alert("ุฎุทุฃ ูู ุงูุชุญููู - ุชุฃูุฏ ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช.");
            }
        });
    }

    function getVal(row, keys) {
        for (let key of keys) {
            if (row[key] !== undefined) return row[key];
        }
        return '-'; 
    }

    function applyDateFilter() {
        const selectedDate = document.getElementById('dateFilter').value;
        if (!selectedDate) { alert("ูุฑุฌู ุงุฎุชูุงุฑ ุชุงุฑูุฎ."); return; }

        const filteredData = allData.filter(row => {
            const dateStr = getVal(row, ['ุงูุชุงุฑูุฎ', 'ุชุงุฑูุฎ', 'Date']);
            if (dateStr === '-') return false;
            const rowDateObj = new Date(dateStr);
            const selectedDateObj = new Date(selectedDate);
            if(isNaN(rowDateObj)) return false;

            return (
                rowDateObj.getFullYear() === selectedDateObj.getFullYear() &&
                rowDateObj.getMonth() === selectedDateObj.getMonth() &&
                rowDateObj.getDate() === selectedDateObj.getDate()
            );
        });

        if (filteredData.length === 0) {
            alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ููุฐุง ุงูุชุงุฑูุฎ: " + selectedDate);
        } else {
            updateDashboard(filteredData, "ุณุฌูุงุช ููู: " + selectedDate);
        }
    }

    function resetFilter() {
        document.getElementById('dateFilter').value = '';
        updateDashboard(allData, "ุนุฑุถ ุฌููุน ุงูุณุฌูุงุช");
    }

    function updateDashboard(data, title) {
        document.getElementById('tableTitle').innerText = title;
        const cleanData = data.filter(r => getVal(r, ['ุงูุงุณู', 'ุงุณู ุงูููุธู']) !== '-');
        const totalRows = cleanData.length;
        
        let siteCount = 0;
        let officeCount = 0;
        cleanData.forEach(r => {
            const workType = getVal(r, ['ููุน ุงูุนูู', 'ุทุจูุนุฉ ุงูุนูู']);
            if (workType.includes('ูููุน')) siteCount++;
            if (workType.includes('ููุชุจ')) officeCount++;
        });

        const uniqueNames = [...new Set(cleanData.map(item => getVal(item, ['ุงูุงุณู', 'ุงุณู ุงูููุธู'])))].length;

        document.getElementById('total-rows').innerText = totalRows;
        document.getElementById('site-work').innerText = siteCount;
        document.getElementById('office-work').innerText = officeCount;
        document.getElementById('unique-names').innerText = uniqueNames;

        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = "";
        
        const displayData = cleanData.slice().reverse(); 
        
        displayData.forEach(row => {
            const tr = document.createElement('tr');
            
            const dateVal = getVal(row, ['ุงูุชุงุฑูุฎ', 'Date']);
            const company = getVal(row, ['ุงูุดุฑูุฉ', 'ุงุณู ุงูุดุฑูุฉ', 'ุงูุนููู']);
            const name = getVal(row, ['ุงูุงุณู', 'ุงุณู ุงูููุธู']);
            const typeWork = getVal(row, ['ููุน ุงูุนูู', 'ุทุจูุนุฉ ุงูุนูู']);
            const status = getVal(row, ['ุญุงูุฉ ุงูููู', 'ุงูุญุงูุฉ']);
            const details = getVal(row, ['ุชูุงุตูู ุงููุดุงุท', 'ุงูุชูุงุตูู', 'ููุงุญุธุงุช']);
            const device = getVal(row, ['ููุน ุงูุฌูุงุฒ', 'ุงูุฌูุงุฒ', 'device']); 
            const transport = getVal(row, ['ูุณููุฉ ุงูููุงุตูุงุช', 'ุงูููุงุตูุงุช', 'transport']);

            let badgeClass = 'bg-secondary';
            if (typeWork.includes('ูููุน')) badgeClass = 'bg-success';
            else if (typeWork.includes('ููุชุจ')) badgeClass = 'bg-warning text-dark';

            tr.innerHTML = `
                <td><strong>${dateVal}</strong></td>
                <td>${company}</td>
                <td>${name}</td>
                <td><span class="badge ${badgeClass}">${typeWork}</span></td>
                <td>${status}</td>
                <td class="text-wrap" style="max-width: 300px; font-size: 0.85rem;">${details}</td>
                <td class="fw-bold text-primary">${device}</td>
                <td class="fw-bold text-info">${transport}</td>
            `;
            tableBody.appendChild(tr);
        });

        renderCharts(siteCount, officeCount, cleanData);
    }

    function renderCharts(site, office, data) {
        if (chart1Instance) chart1Instance.destroy();
        if (chart2Instance) chart2Instance.destroy();

        const ctx1 = document.getElementById('workTypeChart').getContext('2d');
        chart1Instance = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['ุฒูุงุฑุงุช ููุฏุงููุฉ', 'ุนูู ููุชุจู'],
                datasets: [{
                    data: [site, office],
                    backgroundColor: ['#198754', '#ffc107']
                }]
            },
            options: { maintainAspectRatio: false }
        });

        const companyCounts = {};
        data.forEach(row => {
            const ent = getVal(row, ['ุงูุดุฑูุฉ', 'ุงุณู ุงูุดุฑูุฉ', 'ุงูููุทูุฉ']);
            if(ent !== '-') companyCounts[ent] = (companyCounts[ent] || 0) + 1;
        });

        const ctx2 = document.getElementById('regionChart').getContext('2d');
        chart2Instance = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: Object.keys(companyCounts),
                datasets: [{
                    label: 'ุนุฏุฏ ุงูุฃูุดุทุฉ',
                    data: Object.values(companyCounts),
                    backgroundColor: '#0d6efd'
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    function debugColumns() {
        if(foundHeaders.length > 0) {
            alert("ุฃุณูุงุก ุงูุฃุนูุฏุฉ ุงูููุชุดูุฉ:\n\n" + foundHeaders.join("\n"));
        } else {
            alert("ูู ูุชู ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ.");
        }
    }

    init();
</script>

</body>
</html>
